
<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
	<!-- WPF Xaml needs ANSI spaces to validate the code at design time -->
	<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-8">
    <script>
	    
		var Nos = new Array();
		var Level = 0;
	window.addEventListener('message', function(event) { 
	    var payload = JSON.parse(event.data);
	    switch(payload.function)
	    {
		    case "InjectTemplates":
			    InjectTemplates(payload.data);
			 break;
		    case "AdoptTemplate":
			    AdoptTemplate(payload.data);
			    break;
	    }
	    
	    // IMPORTANT: Check the origin of the data! 
	    if (~event.origin.indexOf('http://yoursite.com')) { 
		// The data has been sent from your site 

		// The data sent with postMessage is stored in event.data 
		// console.log(event.data); 
	    } else { 
		// The data hasn't been sent from your site! 
		// Be careful! Do not use it. 
		return; 
	    } 
	}); 
		function getSearchParameters() {
			var prmstr = window.location.search.substr(1);
			return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
		}
		function transformToAssocArray( prmstr ) {
			var params = {};
			var prmarr = prmstr.split("&");
			for ( var i = 0; i < prmarr.length; i++) {
				var tmparr = prmarr[i].split("=");
				params[tmparr[0]] = tmparr[1];
			}
			return params;
		}

		var params = getSearchParameters();

        function TemplateIsEdited() {
            //DirtyTemplate = true;
            // saved directly
            /* This area is only for github. Because they disabled the save of resourcs. */
            // SaveTemplate();
		
		if(SelectedTemplate != null)
		{
            		parent.window.postMessage(JSON.stringify({"function":"SaveTemplate", "data": {"TemplatePath":SelectedTemplate.TemplatePath, "TemplateContent": JSON.stringify(document.getElementById('TemplatePanelInput').value)} }), '*');
		}
		else
		{
			SelectedTemplate = { "Content": "" };
            	}
            SelectedTemplate.Content = document.getElementById('TemplatePanelInput').value;
			
			if(params.processor == 'TabbedToTable')
			{
				TabbedToTable();
				return;
			}
			
            BuildTemplate();
            ApplyTemplate();

            /* ------------------------------------------------------------------------- */
        }
        function BuildTemplate() {
            if (SelectedTemplate) {
                var Result = SelectedTemplate.Content.substring(1, SelectedTemplate.Content.length - 1);
                Lines = Result.split("\n");
                var VariablesOutput = '';
                var isInBlock = -1;
                var VariablesBlock = [];
                for (var l = 0; l < Lines.length; l++) {
                    if (Lines[l].indexOf('============== Vars') > -1) {
                        if (Lines[l].indexOf(' begin') > -1) {
                            isInBlock++;
                            VariablesBlock[isInBlock] = '';
                        }
                        if (Lines[l].indexOf(' end') > -1) {
                            //VariablesOutput += ExpandBlock(VariablesBlock[isInBlock]);
                            isInBlock--;
                        }
                    }
                    else {
                        if (isInBlock >= 0) {
                            VariablesBlock[isInBlock] += Lines[l] + ' \n';
                        }
                        else {
                            VariablesOutput += Lines[l] + ' \n';
                        }
                    }
                }
                if (VariablesBlock.length > 0) {
                    TemplateVariables = JSON.parse(VariablesBlock[0]);
                    //TemplateVariables = JSON.parse(VariablesBlock[0].replace(/\\t/g, '\t').replace(/\\n/g, '\n').replace(/\\\"/g, '"').replace(/\//g, '/'));
                }
            }
        }
    </script>
</head>
<style>
    /* On local project this is in ./css/main.css */

    .template_uppercase {
        font-weight: bold;
        color: #500;
    }

    .template_lowercase {
        font-weight: bold;
        color: gray;
    }

    .template_output {
        position: fixed;
        background-color: #EFF;
        right: 20px;
        left: 600px;
        top: 10px;
        bottom: 10px;
        overflow-x: scroll;
        overflow-x: hidden;
        color: silver;
    }

    .ttt {
        border: 1px solid red;
        text-decoration: none;
        background-color: yellow;
        border-radius: 5px;
        margin: 5px;
        display: inline-block;
        padding: 5px;
    }

    .my_table_card {
        background-color: #FFE
    }

        .my_table_card:hover {
            background-color: #FDC
        }
</style>
<body>
<center>
    <table>
        <tr>
            <td style="width: 250px; min-width: 250px; vertical-align: top">
                <*div id='cards_filter'><input id="cards_filter_input" onkeyup="FilterFloatingCards(this.value)" style='width:100%' /></div>
                <div id='Template_Presets' style='font-size: small'>
                    <span class='ttt' id='Template_Preset_Editor' onmouseenter='Template_Preset_Editor()'>Editor</span>
                    <span class='ttt' id='Template_Preset_Hibrid' onmouseenter='Template_Preset_Hibrid()'>Hibrid</span>
                    <span class='ttt' id='Template_Preset_Output' onmouseenter='Template_Preset_Output()'>Output</span>
                    <span class='ttt' id='Template_Preset_Ready' onmouseenter='Template_Preset_Ready()'>Ready</span>
                </div>
		<div class='ttt' style='width: 240px; background-color: orange; text-align: center' onclick='AcceptChanges()'> Accept Changes </div>
		<div style='width: 240px; text-align: right; color:silver; font-size: x-small'> Test
			<a target='_blank' style='color:orange' href='https://profimedica.github.io/Templater/index.html'>StandAlone</a>, clone from  
			<a style='color:orange' target='_blank' href='https://github.com/profimedica/Templater/blob/master/JS_Embedable/index.html'>GitHub</a> or read 
			<a style='color:orange' target='_blank' href='https://github.com/profimedica/Templater/wiki/Ajuro-Template-Processor'>Wiki</a> 
		    </div>
                <div id='TemplatesList' class='query_tab' style='height:700px; width:240px; overflow: scroll;'>
                    <br class="query_card">
                </div>
                <div id='FloatingObjects' class='query_tab'><br id="FloatingObjectsHeader" class="query_card"></div>
            </td>
            <td style="width: 100%; vertical-align: top">
                <div id='CodeSample' class='code_sample'></div>
                <div id='ResultsetPanel'>
                    <br>
                    <div id='related_objects_panel'>.</div>
                    <table id="example" class="display"></table>
                    <div id="UnderMouse"></div>
                </div>
                <div id='TemplatePanel' class='code_sample'>
                    <textarea id='TemplatePanelInput' onkeyup='TemplateIsEdited()' style='width: 300px; height: 650px;'>
================= Vars begin
{
	"MyAppSpace":"Miap",
	"MyAppClass":"MyModel",
	"Translates":
	{
		"Generated" :
		{
			"int" : "@##RandomInteger(10)##@",
			"bigint" : "@##RandomInteger(100)##@",
			"nvarchar" : "CONCAT('@{Name}@_', CAST(@##RandomInteger(100)##@ AS INT))",
			"nchar" : " CAST(@##RandomInteger(100)##@ AS INT)",
			"decimal" : "@##RandomInteger(100)##@",
			"numeric" : "@##RandomInteger(100)/10##@",
			"reference" : "CONCAT('City_', CAST((SELECT TOP 1 Id as reference FROM @{Referencing_Table}@ WHERE @{Referencing_Table}@.@{Referencing_Column}@ IS NOT NULL ORDER BY NewID()) AS INT))",
			"datetime0" : "DATEADD(MONTH, CAST(@##RandomInteger(11)##@ AS INT), DATEADD(DAY, CAST(@##RandomInteger(29)##@ AS INT), GETDATE()))",
			"datetime" : "DATEADD(DAY, CAST(@##RandomInteger(29)##@ AS INT), GETDATE())",
			"date" : "GETDATE()",
			"bit" : "0"
		}
	},	
	"Tables" : 
	[
		{
			
			"Name" : "Test_Phonebook",
			"Schema" : "dbo",
			"PK" : [ "ProductID", "CustomerID" ],
			"Columns":
			[
				{ "Name":"Id", "Type":"int", "Skeep": 1, "IsKey":1},
				{ "Name":"Name", "Type":"nvarchar", "Precision":"60"},
				{ "Name":"Age", "Type":"int", "Nullable" : true},
				{ "Name":"Phone", "Type":"nvarchar", "Precision":"60", "IsKey":false},
				{ "Name":"Description", "Type":"nvarchar", "Precision":"300", "Nullable" : true, "IsKey" : 2},
				{ "Name":"Note", "Type":"nvarchar", "Precision":"300", "Nullable" : true},
				{ "Name":"City", "Type":"nvarchar", "Precision":"60"},
				{ "Name":"Street", "Type":"nvarchar", "Precision":"60"},
				{ "Name":"URL", "Type":"nvarchar", "Precision":"50", "Nullable" : true},
				{ "Name":"Prints", "Type":"int", "Nullable" : true},
				{ "Name":"ActivFrom", "Type":"datetime", "Nullable" : true},
				{ "Name":"ActivTo", "Type":"datetime", "Nullable" : true},
				{ "Name":"IsDeliveryAddress", "Type":"bit"},
				{ "Name":"Suspended", "Type":"bit"}
			]
		},
		{			
			"Name" : "Test_Customer",
			"Schema" : "dbo",
			"PK" : [ "ProductID", "CustomerID" ],
			"Columns":
			[
				{ "Name":"CustomerId", "Type":"int", "IsKey":true},
				{ "Name":"Phone", "Type":"nvarchar", "Precision":"60", "IsKey":false},
				{ "Name":"Name", "Type":"nvarchar", "Precision":"60", "IsUnique": true},
				{ "Name":"URL", "Type":"nvarchar", "Precision":"50", "Nullable" : true},
				{ "Name":"Age", "Type":"int", "Nullable" : true},
				{ "Name":"Suspended", "Type":"bit"}
			]
		},
		{			
			"Name" : "Test_Address",
			"Schema" : "dbo",
			"PK" : [ "ProductID", "CustomerID" ],
			"Columns":
			[
				{ "Name":"AddressId", "Type":"int", "IsKey":true},
				{ "Name":"CustomerIdRef", "Type":"int", "Referencing_Table": "Test_Customer", "Referencing_Column": "CustomerId"},				
				{ "Name":"Description", "Type":"nvarchar", "Precision":"300", "Nullable" : true, "IsKey" : 2},
				{ "Name":"City", "Type":"nvarchar", "Precision":"60", "IsUnique": true },
				{ "Name":"Street", "Type":"nvarchar", "Precision":"60", "IsUnique": true },
				{ "Name":"Prints", "Type":"int", "Nullable" : true},
				{ "Name":"ActivFrom", "Type":"datetime", "Nullable" : true},
				{ "Name":"ActivTo", "Type":"datetime", "Nullable" : true},
				{ "Name":"Note", "Type":"nvarchar", "Precision":"300", "Nullable" : true},
				{ "Name":"IsDeliveryAddress", "Type":"bit"}
			]
		}
	]
}
================= Vars end
		
!=========== Tables ===========
--------------------------------- DELETE @{Name}@ TYPE ---------------------------------

	IF TYPE_ID(N'@{Schema}@.@{Name}@') IS NOT NULL DROP TYPE [@{Schema}@].[@{Name}@];

--------------------------------- DELETE @{Name}@ TABLES ---------------------------------

	IF OBJECT_ID('@{Schema}@.@{Name}@', 'U') IS NOT NULL DROP TABLE [@{Schema}@].[@{Name}@];
GO

===========!

!=========== Tables ===========
--------------------------------- CREATE @{Name}@ TABLE ---------------------------------

	CREATE TABLE [@{Schema}@].[@{Name}@]
	(
		!=========== Columns ===========
		@~Printed.Columns > 0~@~,~@~~@ [@{Name}@] [@{Type}@]@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@@~(typeof(@{IsKey}@) !== 'undefined' && @{IsKey}@ == true )~@~ IDENTITY(1,1) PRIMARY KEY~@~~@@~(typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ != true )~@~ NULL~@~~@
		===========!	
	) ON [PRIMARY];
GO

--------------------------------- CREATE @{Name}@ TYPE ---------------------------------

	CREATE TYPE [@{Schema}@].[@{Name}@] AS TABLE
	(
		!=========== Columns ===========
		@~Printed.Columns > 0~@~,~@~~@ [@{Name}@] [@{Type}@]@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@
		===========!
	);
GO

===========!

!=========== Tables [{"item":"Test_Customer", "repetitions": 10},{"item":"Test_Address", "repetitions": 5000},{"item":"Test_Phonebook", "repetitions": 0}] ===========

--------------------------------- FILL TABLE @{Name}@ ---------------------------------
	-- Duplicate keys will be ignored
	--SET IDENTITY_INSERT @{Name}@ ON

	INSERT INTO [@{Schema}@].[@{Name}@]
	(
		!=========== Columns ===========
		@~ (typeof(@{IsKey}@)==='undefined'||@{IsKey}@==false) ~@~@~Printed.Columns > 0~@~,~@~~@[@{Name}@]~@~~@
		===========!
	)
	VALUES
	(
		!=========== Columns ===========
		@~ (typeof(@{IsKey}@)==='undefined'||@{IsKey}@==false) ~@~@~Printed.Columns > 0~@~,~@~~@ CONVERT([@{Type}@]@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@, @``Generated``@``@~(typeof(@{Referencing_Table}@) !== 'undefined')~@~reference~@~@{Type}@~@``@@~(typeof( @{Style}@) !== 'undefined')~@~, @{Style}@~@~~@)~@~~@	
		===========!
	);
	
	--SET IDENTITY_INSERT @{Name}@ OFF

GO

===========!

!=========== Tables ===========
--------------------------------- SHOW TABLES CONTENT ---------------------------------

	SELECT TOP 10 * FROM [@{Schema}@].[@{Name}@];

===========!
GO


--------------------------------- Aggregate Data ---------------------------------

IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Test_Get_AggregatedData')
DROP PROCEDURE Test_Get_AggregatedData
GO

-- From SQL Server 2016 DROP PROCEDURE IF EXISTS

CREATE PROCEDURE [dbo].[Test_Get_AggregatedData]
	@startingDatetime			datetime = NULL
,	@endingDatetime				datetime = NULL
AS
DECLARE
	@defaultStartingDatetime datetime, @defaultEndingDatetime datetime
	SET @defaultStartingDatetime = dateadd(hour, datediff(hour, 0, GETDATE())-2, 0)
	SET @defaultEndingDatetime	 = dateadd(hour, datediff(hour, 0, GETDATE())-1, 0)

	-- If no startdate is provided, the startdate is set to last hour -1
	IF @startingDatetime IS NULL
		SET @startingDatetime = @defaultStartingDatetime

	-- If no enddate is provided, the enddate is set to last hour
	IF @endingDatetime IS NULL
		SET @endingDatetime = @defaultEndingDatetime;
	
	-- Only permit queryes for the last complete hours, not for the ongoing hour
	--  IF @endingDatetime > @defaultEndingDatetime
	--	SET @endingDatetime = @defaultEndingDatetime;

				SELECT
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					@~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ [@{Name}@]~@~~@
					===========!
				===========!
				FROM 
					Test_Address a JOIN Test_customer b ON a.CustomerIdRef = b.CustomerId
				WHERE
					a.[ActivFrom] >= @startingDatetime AND a.[ActivFrom] <= @endingDatetime

RETURN   @@ERROR
GO

--------------------------------- Create Support Objects - REPORTS Table ---------------------------------

	IF OBJECT_ID('dbo.Test_Reports', 'U') IS NOT NULL DROP TABLE [dbo].[Test_Reports];
GO

CREATE TABLE [dbo].[Test_Reports](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Transfer_Type] [nvarchar](20) NOT NULL,
	[Starting_Timestamp] [datetime] NULL,
	[Ending_Timestamp] [datetime] NULL,
	[BI_ActivityCasino_RecordsFound] [int] NULL,
	[BI_ActivityCasino_Inserts] [int] NULL,
	[BI_ActivityCasino_InsertErrors] [int] NULL,
	[BI_ActivityCasino_Updates] [int] NULL,
	[BI_Transactions_Updates] [int] NULL,
	[BI_ActivityCasino_Miliseconds] [bigint] NULL,
	[Timestamp] [datetime] NULL
) ON [PRIMARY]
GO

--------------------------------- Create Support Objects - Aggregated TYPE ---------------------------------

	IF TYPE_ID(N'dbo.Test_AggregatedType') IS NOT NULL DROP TYPE [dbo].[Test_AggregatedType];
GO

	CREATE TYPE [dbo].[Test_AggregatedType] AS TABLE
	(
		!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
			!=========== Columns ===========
			 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ [@{Name}@] [@{Type}@]@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@~@~~@
			===========!
		===========!
	);
GO

--------------------------------- Create Support Objects - Aggregated TABLE ---------------------------------

	IF OBJECT_ID('dbo.Test_AggregatedTable', 'U') IS NOT NULL DROP TABLE [dbo].[Test_AggregatedTable];
GO

	CREATE TABLE [dbo].[Test_AggregatedTable]
	(
		Id int
	!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
		!=========== Columns ===========
		@~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~, [@{Name}@] [@{Type}@]@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@@~(typeof(@{IsKey}@) !== 'undefined' && @{IsKey}@ == true )~@~ IDENTITY(1,1) PRIMARY KEY~@~~@@~(typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ != true )~@~ NULL~@~~@~@~~@
		===========!
	===========!	
	) ON [PRIMARY];
GO

--------------------------------- Create Support Objects - UPSERT Procedure ---------------------------------



IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Test_Upsert')
DROP PROCEDURE Test_Upsert
GO

-- From SQL Server 2016 DROP PROCEDURE IF EXISTS

CREATE PROCEDURE [dbo].[Test_Upsert]
	@startingDatetime datetime = NULL,
	@endingDatetime datetime = NULL
AS 
DECLARE 
	!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
		!=========== Columns ===========
		 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ @@{Name}@ @{Type}@@~(typeof(@{Precision}@) !== 'undefined')~@~(@{Precision}@)~@~~@~@~~@
		===========!
	===========!
	,
	-- Using
	@my_TMP dbo.Test_AggregatedType,
	@defaultStartingDatetime datetime,
	@defaultEndingDatetime datetime,
	-- Returning
	@RecordsFound int = 0,
	@Inserts int = 0,
	@Updates int = 0

-- prepare default time interval limits
SET @defaultStartingDatetime = dateadd(hour, datediff(hour, 0, GETDATE())-2, 0)
SET @defaultEndingDatetime = dateadd(hour, datediff(hour, 0, GETDATE())-1, 0)

IF @startingDatetime IS NULL SET @startingDatetime = @defaultStartingDatetime;
IF @endingDatetime IS NULL SET @endingDatetime = @defaultEndingDatetime;
-- IF @endingDatetime > @defaultEndingDatetime SET @endingDatetime = @defaultEndingDatetime; -- Dates in future are not permitted !!!

	DECLARE @error int;

INSERT INTO @my_TMP
	EXEC @error = [dbo].[Test_Get_AggregatedData]
	@startingDatetime,
	@endingDatetime

DECLARE db_cursor CURSOR local
FOR SELECT * FROM @my_TMP

OPEN db_cursor

FETCH NEXT FROM db_cursor into 
	!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
		!=========== Columns ===========
		 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~ @~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ @@{Name}@ ~@~~@
		===========!
	===========!

WHILE @@FETCH_STATUS = 0 
BEGIN
	SET @RecordsFound += 1;
		IF EXISTS 
		(
			SELECT 
				1 
			FROM 
				dbo.[Test_AggregatedTable] 
			WHERE 
				1=1
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					 @~((typeof(@{IsUnique}@) !== 'undefined' && @{IsUnique}@ == true))~@~ AND [@{Name}@] = @@{Name}@ ~@~ ~@
					===========!
				===========! 
		)
		BEGIN
			UPDATE 
			dbo.[Test_AggregatedTable] 
			SET 
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ [@{Name}@] = @@{Name}@ ~@~~@
					===========!
				===========! 
			WHERE 
				1=1
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					 @~((typeof(@{IsUnique}@) !== 'undefined' && @{IsUnique}@ == true))~@~ AND [@{Name}@] = @@{Name}@ ~@~ ~@
					===========!
				===========! 
			;
			SET @Updates += 1;
		END 
		ELSE BEGIN
			INSERT INTO 
			dbo.[Test_AggregatedTable] 
			(
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ [@{Name}@] ~@~~@
					===========!
				===========! 
			)
			VALUES 
			(
				!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
					!=========== Columns ===========
					 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ @@{Name}@ ~@~~@
					===========!
				===========! 
			);
			SET @Inserts += 1;
		END
	FETCH NEXT FROM db_cursor into
		!=========== Tables [{"item":"Test_Phonebook", "repetitions": 0}] ===========
			!=========== Columns ===========
			 @~((typeof(@{IsKey}@) === 'undefined' || @{IsKey}@ == false) && (typeof(@{Referencing_Table}@) === 'undefined'))~@~@~Printed.Tables > 0 || Printed.Columns > 0~@~,~@~~@ @@{Name}@ ~@~~@
			===========!
		===========! 
	END

CLOSE db_cursor 
DEALLOCATE db_cursor
SELECT 'RecordsFound' = @RecordsFound, 'Inserts' = @Inserts, 'Updates' = @Updates
GO

EXEC [dbo].[Test_Upsert] '2016-01-01', '2018-01-01'
GO

-- EXEC  [dbo].[Test_Get_AggregatedData] '2016-01-01', '2018-01-01'
GO


</textarea>
                    <div id='TemplatePanelOutput' class='template_output'>
                    </div>
                    <textarea id='TemplateCopyArea' class='template_output' style='color:#d00; background-color: #ddd; left:10px; width:99%; top:70px; height:800px; bottom:10px; right:10px; display:none'></textarea>
                </div>
            </td>
        </tr>
    </table>
</center>


<script>


    var Templates = null;
    /* Begin of Interface Functions */

    function UpdateTemplate(value, returnOutput)
    {
        document.getElementById('TemplatePanelInput').value = value;
	SelectedTemplate = { "Content": "" };
	SelectedTemplate.Content = document.getElementById('TemplatePanelInput').value;
	BuildTemplate();
	ApplyTemplate();
	if(returnOutput)
	{
		window.external.UserAcceptedChanges(document.getElementById('TemplatePanelOutput').innerText);
	}
    }

    function AcceptChanges()
    {
        window.external.UserAcceptedChanges(document.getElementById('TemplateCopyArea').value);
    }

    /* End of Interface Functions */
    
    function CreateTemplateCard(template_path, file_name)
	{
        var field_name = 'null';
        var signature_ColumnTouched = "ColumnTouched()";
        var signature_ColumnOver = "EditTemplate('" + template_path + "')";
        var signature_ColumnDoubleClick = "ColumnNavigate()";
        var signature_ColumnDoubleClick = "ColumnNavigate()";
        var elementNode = document.createElement('div');
		var textnode = document.createTextNode(file_name);
		elementNode.appendChild(textnode);	
		elementNode.classList.add("my_table_card");	
		elementNode.title = template_path;
		elementNode.classList.add("object_tab_element");	
		elementNode.addEventListener("click", signature_ColumnTouched);	
		elementNode.addEventListener("mouseenter", EditTemplate);
		elementNode.addEventListener("dblclick", signature_ColumnDoubleClick);		
		return elementNode;
	}

    var DirtyTemplate = false;
    var TemplateVariables = { "Columns": [] }; // varibles in json area

    var SelectedTemplate = null;

    function GetTemplateByPath(file_path) 
	{
        return Templates.CS['POCO.txt'];
    }
	
	function RandomInteger(max)
	{
		var min = 1;
		return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	
	function IsLoaded(data)
	{
		SelectedTemplate.Content = data;//.Content;
		SelectedTemplate.TemplatePath = './TemplateExample1.txt'// data.TemplatePath;
		var val = SelectedTemplate.Content;

		/*
		only used for JSON on my local project
		val = val.replace(/\\n/g, '\n');
		val = val.replace(/\\t/g, '\t');
		val = val.replace(/\\r/g, '\r');
		val = val.replace(/\\f/g, '\f');
		// val = val.replace(/\\b/g, '\b');
		val = val.replace(/\\\//g, '\/');
		val = val.replace(/\\\\/g, '\\');
		val = val.replace(/\\"/g, '\"');
		*/
		//$escapers = array( "\x08", "\x0c", "\xa9");
		//$replacements = array( "\\f", "\\b", "(c)");

		document.getElementById('TemplatePanelInput').value = val;
		BuildTemplate();
		ApplyTemplate();
	}
	
	/* Structured content business */
	
	
	var Marking = 
	[ 
		{ markers : [ "!===========", "===========", "===========!" ], "type" : "replace" },
		{ markers : [ "@{", "}@" ], "type" : "replace" },
		{ markers : [ "@~", "~@~", "~@~", "~@" ], "type" : "3per" },
		{ markers : [ "@``", "``@``", "``@" ], "type" : "replace" },
		{ markers : [ "@##", "##@" ], "type" : "replace" }
	];
	var Structure = [];
	var Printed = {};
	function ParseToStructure(content)
	{
		var index = 0;
		var tryMore = true;
		var level = 0;
		var Structure = [];
		Structure.push({ "type" : -1, "positions": [0, 0], "nextAncor":0, "parent": Structure, "children":[] });
		var CurrentF = Structure[0];
		var isInStartingMarker = false;
		var isInMarker = false;
		var isInEndingMarker = false;
			
		while(index<content.length && tryMore)
		{
			if(index > 19342)
			{	
				var x = 0;
			}
			tryMore = false; // assume is last try
			
			var nextMarkerPosition = -1;
			var type = null;
			var nextAncor=0;
			// Try my continuation
			if(CurrentF.type > -1 && CurrentF.nextAncor < Marking[CurrentF.type].markers.length){
				var startingPos = content.indexOf(Marking[CurrentF.type].markers[CurrentF.nextAncor], index);
				if(startingPos > -1 && (startingPos < nextMarkerPosition || nextMarkerPosition<0))
				{
					nextMarkerPosition = startingPos;
					type = CurrentF.type;
					nextAncor = CurrentF.nextAncor+1;
					isInStartingMarker = true;
					isInMarker = false;
					isInEndingMarker = false;
					tryMore = true; // you fond something
				}
			}
			// Try other starts
			for(var a = 0; a < Marking.length; a++ )
			{
				var ancor = 0;
				if(a == CurrentF.type)
				{
					// Can I include myself ?
					//ancor = CurrentF.nextAncor;
				}
				else
				{
					//ancor = 0;
				}
				var startingPos = content.indexOf(Marking[a].markers[ancor], index);
				if(startingPos > -1 && (startingPos < nextMarkerPosition || nextMarkerPosition<0))
				{
					nextMarkerPosition = startingPos;
					type = a;
					nextAncor = ancor+1;
					isInStartingMarker = true;
					isInMarker = false;
					isInEndingMarker = false;
					tryMore = true; // you fond something
				}				
			}
			if(type == null)
			{
				// Nothig found
				break;
			}
			var markerLength = Marking[type].markers[nextAncor-1].length;
			if(type <2 && nextAncor == 1)
			{
				//markerLength = content.indexOf('\n', nextMarkerPosition+markerLength)+5-nextMarkerPosition;
			}
			if(nextAncor == 1)
			{
				var Child = { "type" : type, "positions": [nextMarkerPosition, nextMarkerPosition+markerLength], "parent": CurrentF, "children":[], "nextAncor":nextAncor };
				CurrentF.children.push(Child);
				CurrentF = Child;
			}
			else if(nextAncor < Marking[type].markers.length)
			{
				CurrentF.positions.push(nextMarkerPosition);
				CurrentF.positions.push(nextMarkerPosition+markerLength);
				CurrentF.nextAncor = nextAncor;
			}
			else if(nextAncor == Marking[type].markers.length)
			{
				CurrentF.positions.push(nextMarkerPosition);
				CurrentF.positions.push(nextMarkerPosition+markerLength);
				CurrentF.nextAncor = nextAncor;
				var segment = content.substr(nextMarkerPosition, markerLength);
				var outerContent = content.substr(CurrentF.positions[0], nextMarkerPosition+markerLength-CurrentF.positions[0]);
				CurrentF.outerContent = outerContent;
				var innerContent = content.substr(CurrentF.positions[1], nextMarkerPosition-CurrentF.positions[1]);
				CurrentF.innerContent = innerContent;
				CurrentF = CurrentF.parent;
			}
			var segment = content.substr(nextMarkerPosition, markerLength);
			index = nextMarkerPosition + markerLength;
			var marker = nextMarkerPosition;
		};
		return Structure;
	}
	
	function TestCase(content, vars)
	{
		Structure = [];
		Structure = ParseToStructure((content));
		Structure[0].variables = vars;
		return Reduce(Structure[0], (content));		
	}
	
	function TestAllCases()
	{
		var vars =
		{
			"Name" : "Root", "Precision":"60",
			"Translates":
			{
				"Generated" :
				{
					"T1" : "Translated_T1",
					"T2" : "Translated_T2",
					"Root" : "Translated_{@{Name}@.@{Precision}@}"
				}
			},	
			"Tables" : 
			[
				{
					
					"Name" : "T1",
					"Schema" : "dbo",
					"Columns":
					[
						{ "Name":"C1", "Type":"int", "Skeep": 1, "IsKey":1},
						{ "Name":"C2", "Type":"nvarchar", "Precision":"60", "IsKey":false},
						{ "Name":"C3", "Type":"nvarchar", "Precision":"300", "Nullable" : true, "IsKey" : 2}
					]
				},
				{
					
					"Name" : "T2",
					"Schema" : "dbo",
					"Columns":
					[
						{ "Name":"D1", "Type":"int", "Skeep": 1, "IsKey":1},
						{ "Name":"D2", "Type":"nvarchar", "Precision":"60", "IsKey":false}
					]
				}
			]
		};
		
		var cases = 
		[
			'@## 2+3 ##@',
			'@``Generated``@``@{Name}@``@',
			'!=========== Tables ===========!=========== Columns ======================!1234567890	) ON [PRIMARY];===========!',
			'1@{Name}@2',
			'1@{Name}@2@{Name}@3',
			'1@{Name}@2@{Name}@3		',
			'@~(typeof(@{Precision}@) !== "undefined")~@~(@{Name}@)~@~~@',
			'!=========== Tables ===========1@{Name}@2===========!',
			'!=========== Tables ===========1@{Name}@2===========!\n		!=========== Tables ===========3@{Name}@4===========!',
			'!=========== Tables ===========1@{Name}@2!=========== Columns ===========3@{Name}@4===========!===========!',
			'!=========== Tables ===========!=========== Columns ===========@~(typeof(@{IsKey}@)==="undefined"||@{IsKey}@==false)~@~@~Printed.Columns > 0~@~,~@~~@[@{Name}@]~@~~@===========!===========!'
		];
		var results = 
		[
			"<span style='color:black'><span style='color:black'>5</span></span>",
			"<span style='color:black'><span style='color:black'>Translated_{<span class='template_uppercase'>Root</span>.<span class='template_uppercase'>60</span>}</span></span>",
			"<span style='color:black'><span style='color:black'><span style='color:black'></span><span style='color:black'></span><span style='color:black'></span>1234567890	) ON [PRIMARY];</span><span style='color:black'><span style='color:black'></span><span style='color:black'></span>1234567890	) ON [PRIMARY];</span></span>",
			"<span style='color:black'>1<span class='template_uppercase'>Root</span>2</span>", 
			"<span style='color:black'>1<span class='template_uppercase'>Root</span>2<span class='template_uppercase'>Root</span>3</span>", 
			"<span style='color:black'>1<span class='template_uppercase'>Root</span>2<span class='template_uppercase'>Root</span>3		</span>", 
			"<span style='color:black'>(Root)</span>",
			"<span style='color:black'><span style='color:black'>1<span class='template_uppercase'>T1</span>2</span><span style='color:black'>1<span class='template_uppercase'>T2</span>2</span></span>",
			"<span style='color:black'><span style='color:black'>1<span class='template_uppercase'>T1</span>2</span><span style='color:black'>1<span class='template_uppercase'>T2</span>2</span>\n		<span style='color:black'>3<span class='template_uppercase'>T1</span>4</span><span style='color:black'>3<span class='template_uppercase'>T2</span>4</span></span>",
			"<span style='color:black'><span style='color:black'>1<span class='template_uppercase'>T1</span>2<span style='color:black'>3<span class='template_uppercase'>C1</span>4</span><span style='color:black'>3<span class='template_uppercase'>C2</span>4</span><span style='color:black'>3<span class='template_uppercase'>C3</span>4</span></span><span style='color:black'>1<span class='template_uppercase'>T2</span>2<span style='color:black'>3<span class='template_uppercase'>D1</span>4</span><span style='color:black'>3<span class='template_uppercase'>D2</span>4</span></span></span>",
		];
		for(var i=0;i<cases.length;i++)
		{
			var result = TestCase(cases[i], vars);
			if(result != results[i])
			{
				console.log("Test Case " + i + ": " + result);
			}
			else
			{
				console.log("Test Case " + i + ": OK");
			}
		}
	}
	
	function Reduce(CurrentF, content, noFormat_offset = 0)
	{
		if(CurrentF.outerContent=="@~(typeof(@{IsKey}@)==='undefined'||@{IsKey}@==false)~@~@~Printed.Columns > 0~@~,~@~~@[@{Name}@]~@~~@")
		{
			var x = 0;
		}
		var ref_index = 1; 
		if(CurrentF.type == 0)
		{
			ref_index = 3;
		}
		var expression = content;
		if(CurrentF.positions.length > 2)
		{
			var expression = content.substr(CurrentF.positions[ref_index], CurrentF.positions[CurrentF.positions.length-2]-CurrentF.positions[ref_index]);
		}
		
		variables = null;
		var offset = 0;
		for(var i=0; i<CurrentF.children.length; i++)
		{
			// if(i>3)return expression;
			
			if(CurrentF.children[i].type == 0) // Change Variables Set
			{
				if(CurrentF.children[i].innerContent.indexOf('"s":0}]')>0)
				{
					var x = 0;
				}				
				var varset = RemoveFormat(content.substr(CurrentF.children[i].positions[1], CurrentF.children[i].positions[2]-CurrentF.children[i].positions[1])).trim();
				//if(typeof(Printed[varset])==='undefined')
				{
				}
				var instructions = {}
				if(varset.indexOf(' ') > -1)
				{
					instructions = eval(varset.substr(varset.indexOf(' ') + 1));
					varset = varset.substr(0, varset.indexOf(' '));
				}
				Printed[varset]=-1;
				var varsOrder = ListVariablesToApply(CurrentF, {"varset" : varset, "instructions" : instructions} );
				var replacement = "";
				//for(var k =0; k<varsOrder.length; k++)
				for(var k = 0; k<varsOrder.length; k++)
				{
					Printed[varset]++;
					CurrentF.children[i].variables = varsOrder[k];
					replacement += Reduce(CurrentF.children[i], content, (CurrentF.children[i].type == 2 || CurrentF.children[i].type == 3 ? CurrentF.children[i].positions[2] : noFormat_offset));
					
					var checkempty  = replacement.replace(/<\/span>/g, '').replace(/<span style='color:black'>/g, '').replace(/<span class='template_uppercase'>/g, '').replace(/&nbsp;/g, '').replace(/<\/br>/g, '')
					if(checkempty.trim().length == 0)
					{
						Printed[varset]--;
					}
					var x = 0;
				}
				if(replacement != "")
				{
					//replacement = replacement.substr(6);
				}
				
				{
					var ff = CurrentF.positions.length-1;
					if(CurrentF.children[i].type == 0)
					{
						//ff = CurrentF.children[i].positions.length-3;
					}
					var pre = expression.length;
					expression = expression.substr(0, offset + (CurrentF.children[i].positions[0] - CurrentF.positions[ref_index])) 
						+ replacement 
						+ expression.substr(offset + (CurrentF.children[i].positions[CurrentF.children[i].positions.length-1] - CurrentF.positions[ref_index]));
					offset += expression.length - pre;
				}
			}
			else
			{
				if(CurrentF.children[i].positions[0] == 19459)
				{
					var x = 0;
				}
				CurrentF.children[i].variables = CurrentF.variables;
				var replacement = Reduce(CurrentF.children[i], content, (CurrentF.children[i].type ==  2 || CurrentF.children[i].type ==  3 ? CurrentF.children[i].positions[2] : noFormat_offset));
				var pre = expression.length;
				var ff = 1;//CurrentF.positions.length-1;
				var bb = 0;
				if(CurrentF.type == 0)
				{
					ff = CurrentF.positions.length-3;
					bb = ref_index;
				}
				if(CurrentF.type == 2)
				{
					ff = 1;
					bb = 1;
				}
				//expression = expression.substr(0, offset + (CurrentF.children[i].positions[0] - CurrentF.positions[ref_index])) + replacement + expression.substr(offset + (CurrentF.children[i].positions[CurrentF.children[i].positions.length-1]-CurrentF.positions[0]));
				  expression = expression.substr(0, offset + (CurrentF.children[i].positions[0] - CurrentF.positions[ff])) + replacement + expression.substr(offset + (CurrentF.children[i].positions[CurrentF.children[i].positions.length-1]-CurrentF.positions[bb]));
				if(replacement == null)
				{
					var x = 0;
				}
				offset += expression.length - pre;
				// !!! Is it commutative?
				var x = 0;
			}
		}
				
		if(CurrentF.positions[0] < noFormat_offset)
		{
			var replacement = expression;
		}
		else
		{
			var replacement = "<span style='color:black'>"+expression+"</span>";
		}
		
		switch(CurrentF.type)
		{
			case 0:
				// This is a fragment. I already parsed it.
				break;
			case 1:
				// @{Name}@ 
				// This is a simple variable replacement.
				replacement = ReplaceProperties(expression, CurrentF.variables, (noFormat_offset>0));
				break;
			case 2:
				// @~ Name=='T1' ? ~@~ Yes ~@~ No ~@
				// Conditional evaluation
				replacement = EvaluateConditional(expression, CurrentF);
				break;
			case 3:
				// @`` Dictionary_To_Use ``@`` Key_To_Use ``@
				// Import from dictionary
				replacement = ImportFromDictionary(expression, CurrentF);
				var Structure2 = ParseToStructure(replacement);
				Structure2[0].variables = CurrentF.variables;
				replacement = Reduce(Structure2[0], (replacement));
				break;
			case 4:
				// @## index ##@
				// Output the result of evaluation
				replacement = eval(RemoveFormat(expression));
				break;
		}
		return replacement;
	}
	
	function ImportFromDictionary(expression, CurrentF)
	{
		var pureConditional = false; 
		var fragments = expression.split('``@``');
		var Dictionary = null;
		var Curr = CurrentF;
		while(Dictionary == null && Curr != null)
		{
			if(Curr.variables.hasOwnProperty('Translates'))
			{
				Dictionary = Curr.variables['Translates'];
			}
			Curr = Curr.parent;
		}
		if (Dictionary.hasOwnProperty(fragments[0])) 
		{
			return Dictionary[fragments[0]][fragments[1]];
		}
		else 
		{
			return "";
		}
	}
	
	function ListVariablesToApply(CurrentF, specifications)
	{
		//  Parse Specifications
		
		var List = [];
		{			
			for (var property in CurrentF.variables[specifications.varset]) 
			{
				var specs = null;
				for(var i =0; i < specifications.instructions.length; i++)
				{
					if(specifications.instructions[i].item == CurrentF.variables[specifications.varset][property].Name)
					{
						specs = specifications.instructions[i];
					}
				}
				var repetitions = specs == null ? 1 : specs.repetitions;
				
				for(var i =0; i < repetitions; i++)
				{
					List.push(CurrentF.variables[specifications.varset][property]);
				}
			}
		}
		return List;
	}
	
	
	
	
	
	/* Structured content business */
	
	function LoadDoc(url) 
	{
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() 
		{
			if (this.readyState == 4 && this.status == 200) 
			{
				IsLoaded(this.responseText);
			}
		};
		xhttp.open("GET", url, true);
		xhttp.send();
	}
	
    function EditTemplate(template_path) {
        if (DirtyTemplate) {
            // currently edited template is not saved
            return;
        }
		var url = template_path.target.title;
            
		//LoadDoc('https://raw.githubusercontent.com/profimedica/Templater/master/Templates/'+url);
		if (!window.location.href.match(/localhost/gi)) 
		{
			//document.domain = "github.com";
		} 
	    	parent.window.postMessage(JSON.stringify({"function":"EditTemplate", "data":template_path.target.title}), '*');
		
	        //parent.EditTemplate(template_path);
	    
		return;
    }

	function AdoptTemplate(data)
	{
            // SelectedTemplate = GetTemplateByPath(data.TemplatePath);
            SelectedTemplate.Content = data.Content;
            SelectedTemplate.TemplatePath = data.TemplatePath;
            var val = SelectedTemplate.Content;

	val = val.replace(/\\n/g, '\n');
	val = val.replace(/\\t/g, '\t');
	val = val.replace(/\\r/g, '\r');
	val = val.replace(/\\f/g, '\f');
	// val = val.replace(/\\b/g, '\b');
	val = val.replace(/\\\//g, '\/');
	val = val.replace(/\\\\/g, '\\');
	val = val.replace(/\\"/g, '\"');
            //$escapers = array( "\x08", "\x0c", "\xa9");
            //$replacements = array( "\\f", "\\b", "(c)");
		SelectedTemplate.Content = val;
            document.getElementById('TemplatePanelInput').value = val;
            BuildTemplate();
            ApplyTemplate();
    }

    function Template_Preset_Editor() {
        document.getElementById('TemplatePanelOutput').style.marginLeft = "2000px";
        document.getElementById('TemplatePanelInput').style.width = "100%";
    }

    function Template_Preset_Hibrid() {
        document.getElementById('TemplatePanelOutput').style.marginLeft = "10px";
            document.getElementById('TemplatePanelInput').style.width = "320px";
    }

    function Template_Preset_Output() {
        document.getElementById('TemplatePanelOutput').style.marginLeft = "-335px";
            document.getElementById('TemplatePanelInput').style.width = "0px";
    }

    function Template_Preset_Ready() {
        document.getElementById('TemplateCopyArea').value=(document.getElementById('TemplatePanelOutput').innerText);
        document.getElementById('TemplateCopyArea').style.display = (document.getElementById('TemplateCopyArea').style.display == "none" ? "block" : "none");
    }

    var currentVariables = null;
	
	function EvaluateConditional(expression, CurrentF)
	{
		var pureConditional = false; 
		var fragments = expression.split('~@~');
		try
		{
			if (eval(RemoveFormat(fragments[0])))
			{
				return fragments[1];
			}
			else
			{
				return fragments[2];
			}
		}
		catch(Exception)
		{
			var t = 0;
		}
	}
	
	function ReplaceProperties(expression, variables, noFormat = false)
	{
		prefix = "<span class='template_uppercase'>";
		sufix = "</span>";
		if(noFormat)
		{
			prefix = '';
			sufix = '';
		}
		if(expression.indexOf('Skeep')>0)
		{
			var s =0;
		}
		
		for (var property in variables) 
		{
			if (variables.hasOwnProperty(property)) {
				//, function (i, val) {
				if (typeof (variables[property]) == "string") {
					//expression = expression.replace(new RegExp("" + property + "", "g"), "<span style='color:red'>"+variables[property].toUpperCase()+"</span>" );
					expression = expression.replace(new RegExp("" + property + "", "g"), prefix+variables[property]+sufix );
					//expression = expression.replace(new RegExp("@\\[" + property + "\\]@", "g"), "<span style='color:red'>"+variables[property].toLowerCase()+"</span>" );
				}
				else if (typeof(variables[property]) == "number") {
					expression = expression.replace(new RegExp("" + property + "", "g"), prefix+variables[property]+sufix );
				}
				else if (typeof(variables[property]) == "boolean") {
					//expression = expression.replace(new RegExp("" + property + "", "g"), "<span style='color:red'>"+(variables[property]?'TRUE':'FALSE')+"</span>" );
					expression = expression.replace(new RegExp("" + property + "", "g"), prefix+variables[property]+sufix );
					//expression = expression.replace(new RegExp("@\\[" + property + "\\]@", "g"), "<span style='color:red'>"+(variables[property]?'true':'false')+"</span>" );
				}
			}
		};
		return expression
	}
	
	function CleanFormat(Result)
	{
		Result = Result.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/g, '\t');
		Result = Result.replace(/&nbsp;/g, ' ');
		Result = Result.replace(/&lt;/g, '<');
        return Result; 
	}
	
	function RemoveFormat(Result)
	{
		Result = Result.replace(/&nbsp;/g, ' ');
        Result = Result.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/g, '\t');
        Result = Result.replace(/&lt;/g, '<');
        //Result = Result.replace(/\"/g, '"');
        //Result = Result.replace(/\//g, '/');
        //Result = Result.replace(/\</br>/g, '\n');
            
        return Result; 
	}
	
	function AddFormat(Result)
	{
        Result = Result.replace(/</g, '&lt;\n');
		Result = Result.replace(/ /g, '&nbsp;');
        Result = Result.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        Result = Result.replace(/\n/g, '</br>\n');
            
        return Result; 
	}

    function ApplyTemplate() {
        if (SelectedTemplate) {
            var Result = AddFormat(SelectedTemplate.Content.substring(1, SelectedTemplate.Content.length - 1));
            TemplateLines = Result.split("\n");

            var TemplateOutput = '';
            block = '';
            var ExpansionBlocks = [];
            var FragmentLines = [];
            FragmentRepetitions = 1;
            var ignore = false;// to ignore metadata like variables

            for (var l = 0; l < TemplateLines.length; l++) {
                if (TemplateLines[l].indexOf("==============&nbsp;Vars") > -1) {
                    if (TemplateLines[l].indexOf('&nbsp;begin') > -1) {
                        ignore = true;
		   }
                    if (TemplateLines[l].indexOf('&nbsp;end') > -1) {
                        ignore = false;
                        continue;
                    }
                }
                if (ignore) {
                    continue;
                }
                FragmentLines.push(TemplateLines[l]);
            }
			
			var content = Result.substring(Result.indexOf('=================&nbsp;Vars&nbsp;end')+36);
			//var content =  SelectedTemplate.Content.substring(1, SelectedTemplate.Content.length - 1);
			//content = content.substring(content.indexOf('================= Vars end')+26);
			
			//TestAllCases();
			
			Structure = ParseToStructure((content));
			Structure[0].variables = TemplateVariables;
			var processed = Reduce(Structure[0], (content));
			document.getElementById('TemplatePanelOutput').innerHTML=(processed);
			
            //TemplateOutput = SolveFragment(FragmentLines, TemplateVariables, 0);
            //document.getElementById('TemplatePanelOutput').innerHTML=(TemplateOutput);
        }
    }

    function SaveTemplate() {
        var postdata =
            {
                "action": "save_template",
                "template_path": SelectedTemplate.TemplatePath,
                "content": JSON.stringify(document.getElementById('TemplatePanelInput').value)
            };
        $.ajax({
            type: "POST",
            url: './api/templater/index.php',
            data: JSON.stringify(postdata),
            dataType: "json"
        }).done(function (data, m, n) {
            SelectedTemplate = GetTemplateByPath(data.TemplatePath);
            SelectedTemplate.Content = data.Content;
            BuildTemplate();
            ApplyTemplate();
        }).fail(FailedAction);
    }

    function FailedAction(a, b, c) {
        console.log(a.responseText);
    }
	
	function InjectTemplates(data)
	{
		for (var folder_name in data) {
			if (data.hasOwnProperty(folder_name)) {
				for (var template_name in data[folder_name]) {
					if (data[folder_name].hasOwnProperty(template_name)) {
						CurrenttemplatePath = folder_name + '/' + template_name;
						var card = CreateTemplateCard(folder_name + '/' + template_name, folder_name + ' ' + template_name.substring(0, (template_name.length) - 4));
						document.getElementById("TemplatesList").appendChild(card);
					}
				}
			}
		}
	}

    function DisplayTemplates() {
        if (typeof (DisplayOnly) === "function")
        {
            DisplayOnly('Templates');
        }
        //document.getElementById('TemplatesList').replaceWith("<div id='TemplatesList' class='query_tab'></div>");
        var postdata =
        {
            "action": "list_templates"
        };
		
		var data = 
		{ 
			"WPF":{ "SimpleWindow.txt":{}}, 
			"SQL":{"CreateObjects.txt":{}} 
		};
		Templates = data;
		for (var folder_name in data) {
			if (data.hasOwnProperty(folder_name)) {
				for (var template_name in data[folder_name]) {
					if (data[folder_name].hasOwnProperty(template_name)) {
						var card = CreateTemplateCard(folder_name + '/' + template_name, folder_name + ' ' + template_name.substring(0, (template_name.length) - 4));
						document.getElementById("TemplatesList").appendChild(card);
					}
				}
			}
		}
    }

    // On my local project is in EasyNavigatorManager.js
    function FilterFloatingCards(newValue)
    {
        document.cookie = "FloatingCards_FilterValue=" + newValue;
        newValue = newValue.toLowerCase();
        var card = $('.my_table_card').each(function ()
        {
            if (this.innerText.toLowerCase().indexOf(newValue) > -1)
            {
                $(this).show();
            }
            else
            {
                $(this).hide();
            }
        });
    }

    // On my local project is in index.js
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
	
	function TabbedToTable()
	{
		SelectedTemplate.Content = '{| class="wikitable" ' + SelectedTemplate.Content.replace(new RegExp("\t((.|\n)*)$", "gm"), "").replace(new RegExp("\n(?:.(?!\n))+$", "gm"), "").replace(new RegExp("^(([^\t^\n])*)\n", "gm"), "<br>\n|$1 ") + '<br>\n|-<br>\n|' + SelectedTemplate.Content.replace(new RegExp("^(([^\t^\n])*)\n", "gm"), "").replace(new RegExp("\n", "g"), "<br>\n|-<br>\n| ").replace(new RegExp("\t", "g"), "<br>\n| ")+"<br>\n|}";
		document.getElementById('TemplatePanelOutput').innerHTML = SelectedTemplate.Content;
	}
    
	DisplayTemplates();
	TemplateIsEdited();
	 
</script>
    </body>
</html>+
